<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycompany.matdongsan.dao.AgentDao">

	<!-- 중개인 회원가입 -->
	<insert id="joinByAgent" parameterType="Agent">
		<selectKey keyProperty="anumber" resultType="int"
			order="BEFORE">
			select seq_anumber.nextval from dual
		</selectKey>
		insert into agent(anumber,aname, abrand, aphone,
		aaddress,APROFILEDATA,APROFILEONAME,APROFILETYPE,
		ALATITUDE,ALONGITUDE,APOSTCODE,AADDRESSDETAIL,A_UNUMBER)
		values
		(#{anumber},#{aname}, #{abrand}, #{aphone}, #{aaddress},
		#{aprofiledata},#{aprofileoname},#{aprofiletype},#{alatitude},#{alongitude},#{apostcode},#{aaddressdetail},#{aUnumber})
	</insert>
	<select id="getAgentNumberByUserNumber" parameterType="int"
		resultType="int">
		select anumber from agent
		where a_unumber = #{userNumber}
	</select>
	<!-- 전체 중개인 수 -->
	<select id="getAllAgentCount" resultType="int">
		select
		count(*)
		from
		agent
	</select>

	<!-- 전체 중개인 리스트 -->
<select id="getAgentListByKeyword" resultType="Agent">
    <![CDATA[
    SELECT *
    FROM (
        SELECT a.*, 
               COALESCE(ar.commentCount, 0) AS commentCount, 
               COALESCE(ar.arrate, 0) AS arrate,
               ROW_NUMBER() OVER (
    ]]>
    <choose>
        <when test="byComment == 'many'">
            <![CDATA[ORDER BY COALESCE(ar.commentCount, 0) DESC]]>
        </when>
        <when test="byComment == 'less'">
            <![CDATA[ORDER BY COALESCE(ar.commentCount, 0) ASC]]>
        </when>
        <when test="byRate == 'high'">
            <![CDATA[ORDER BY COALESCE(ar.arrate, 0) DESC]]>
        </when>
        <when test="byRate == 'low'">
            <![CDATA[ORDER BY COALESCE(ar.arrate, 0) ASC]]>
        </when>
        <when test="byDate == 'desc'">
            <![CDATA[ORDER BY a.anumber DESC]]>
        </when>
        <when test="byDate == 'asc'">
            <![CDATA[ORDER BY a.anumber ASC]]>
        </when>
        <otherwise>
            <![CDATA[ORDER BY a.anumber DESC]]>
        </otherwise>
    </choose>
    <![CDATA[
               ) AS rnum
        FROM Agent a
        LEFT JOIN (
            SELECT ar_anumber, COUNT(*) AS commentCount, AVG(arrate) AS arrate
            FROM agent_review
            GROUP BY ar_anumber
        ) ar ON a.anumber = ar.ar_anumber
    ]]>
    <if test="keyword != null and keyword != ''">
        <![CDATA[
        AND (a.abrand LIKE '%' || #{keyword} || '%'
        OR a.aname LIKE '%' || #{keyword} || '%'
        OR a.aaddress LIKE '%' || #{keyword} || '%')
        ]]>
    </if>
    <![CDATA[
    )
    WHERE rnum BETWEEN #{offset} + 1 AND #{offset} + #{limit}
    ]]>
</select>


	<!-- 전체 중개인 리스트 -->
	<select id="getAgentList" parameterType="map" resultType="Agent">
    <![CDATA[
    SELECT *
    FROM (
        SELECT a.*, ROW_NUMBER() OVER (ORDER BY a.anumber desc) AS rnum
        FROM Agent a
    )
    WHERE rnum BETWEEN #{offset} + 1 AND #{offset} + #{limit}
    ]]>
	</select>

	<!-- <select id="getAgentList" resultType="Agent"> select * from agent </select> -->

	<select id="getAgentDataByUserNumber" parameterType="int"
		resultType="Agent">
		SELECT *
		FROM agent
		where a_unumber = #{userNumber}
	</select>
	<select id="getAgentDataByAgentNumber" parameterType="int"
		resultType="Agent">
		SELECT *
		FROM agent
		where anumber = #{agentNumber}
	</select>
	<update id="updateAgentData" parameterType="Agent">
		update agent set
		abrand=#{abrand},aname=#{aname},
		aphone=#{aphone},aaddress=#{aaddress},

		<if test="aprofileoname != null">
			aprofileoname=#{aprofileoname},
			aprofiletype=#{aprofiletype},
			aprofiledata=#{aprofiledata},
		</if>

		apostcode=#{apostcode},aaddressdetail=#{aaddressdetail},alatitude=#{alatitude},alongitude=#{alongitude}
		where anumber=#{anumber}
	</update>

	<select id="getUserNumberByAnumber" parameterType="int"
		resultType="int">
		select a_unumber from agent
		where anumber = #{anumber}
	</select>
</mapper>